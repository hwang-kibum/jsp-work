#!/bin/bash

########################################
##########  Rocky 8.6 취약점 ###########
########################################


source 00.util_Install_latest

read  -p "client server? do not Server Vulnerability config (y/n) :" STAT

if [ ${STAT} == 'y' ];then
	exit;
fi 

str=$(cat /etc/*-release | grep PRETTY_NAME | awk '{print $3}')
OS_VER=${str:0:1}

if [ ${OS_VER} == "8" ]
then
        echo "Rocky-8"
	#sed -i '5 i\auth\t   required\t/lib/security/pam_securetty.so' /etc/pam.d/login
	sed -i 's/PermitRootLogin yes/PermitRootLogin no/' /etc/ssh/sshd_config
	#패스워드 최소 길이 설정#
	sed -i '41,41 s/PASS_MIN_LEN.*/PASS_MIN_LEN\t8/g' /etc/login.defs

	#패스워드 최대 사용기간 설정#
	sed -i '39,39 s/PASS_MAX_DAYS.*/PASS_MAX_DAYS\t90/g' /etc/login.defs

	#패스워드 최소 사용기간 설정#
	sed -i '40,40 s/PASS_MIN_DAYS.*/PASS_MIN_DAYS\t1/g' /etc/login.defs
 	systemctl restart sshd

elif [ ${OS_VER} == "9" ]
then
        echo "Rocky-9"
	sed -i 's/#PermitRootLogin prohibit-password/PermitRootLogin no/' /etc/ssh/sshd_config
 	#패스워드 최소 길이 설정#
	sed -i '132 i PASS_MIN_LEN\t2' /etc/login.defs
 	#패스워드 최대 사용기간 설정#
 	sed -i -e "s/PASS_MAX_DAYS\s*99999/PASS_MAX_DAYS   90/g" /etc/login.defs
  	#패스워드 최소 사용기간 설정#
	sed -i -e "s/PASS_MIN_DAYS\s*0/PASS_MIN_DAYS   1/g" /etc/login.defs
else
        echo "not redhat linux ..."
        str=$(cat /etc/*-release | grep PRETTY_NAME | awk '{print $2}')
        OS_VER=${str:0:2}
        str=$(cat /etc/*-release | grep PRETTY_NAME | awk '{print $1}')
        OS_NAME=${str:13:6}
        echo ${OS_NAME} ${OS_VER}

        if [ ${OS_NAME} == "Ubuntu" ]
        then
                "Not dev..."
        else
                "Not Know...OS..."
                exit
        fi
fi



#패스워드 복잡성 설정#
#sed -i '15 i\password    requisite\t  pam_cracklib.so retry=3 minlen=8 lcredit=-1 ucredit=-1 dcredit=-1 ocredit=-1' /etc/pam.d/system-auth

#root 계정 su 제한#
#groupadd wheel




chgrp wheel /usr/bin/su
chmod 4750 /usr/bin/su
usermod -aG wheel ${SU_USER}
usermod -aG wheel root
 


#패스워드 변경 경고 보내는 일수
#sed -i '28,28 s/PASS_WARN_AGE.*/PASS_WARN_AGE\t7/g' /etc/login.defs centos7은 7일로 되어있어서 안해도 됨

#Session Timeout 설정
echo -e "TMOUT=600\nexport TMOUT\n" >> /etc/profile
source /etc/profile

#정책에 따른 시스템 로깅 설정#
sed -i '67, 67 s/:omusrmsg:*//g' /etc/rsyslog.conf
sed -i '75 i\*.alert\t\t\t\t\t    /dev/console' /etc/rsyslog.conf 
systemctl restart rsyslog

#crond 파일 소유자 및 권한 설정#
chmod 750 /usr/bin/crontab
chmod 640 /etc/crontab
chmod 600 /etc/cron.deny 

#at 서비스 권한 설정#
chmod 750 /usr/bin/at
chmod 640 /etc/at.deny

#로그온 시 경고 메시지 제공#
#서버 로그인 메세지#
echo > /etc/motd.d/cockpit
sed -i '1 i\###########################################################################' /etc/motd.d/cockpit
sed -i '2 i\#                  This is a private computer facility.                   #' /etc/motd.d/cockpit
sed -i '3 i\#   Access for any reason must be specifically authrized by the manager.  #' /etc/motd.d/cockpit
sed -i '4 i\#Unless you are so authorized, your continued access and ant other use may#' /etc/motd.d/cockpit
sed -i '5 i\#             expose you to criminaland or civil proceedings              #' /etc/motd.d/cockpit
sed -i '6 i\###########################################################################' /etc/motd.d/cockpit


# ssh 로그인 메세지#
sed -i '129 i\Banner /etc/issue.net' /etc/ssh/sshd_config
echo > /etc/issue.net
sed -i '1 i\###########################################################################' /etc/issue.net
sed -i '2 i\#                                                                         #' /etc/issue.net
sed -i '3 i\#                             !!!WARNNING!!!                              #' /etc/issue.net
sed -i '4 i\#                                                                         #' /etc/issue.net
sed -i '5 i\###########################################################################' /etc/issue.net
sed -i '6 i\                !!! This System is for authrized user only !!!             ' /etc/issue.net

#/etc/hosts 파일 소유자 및 권한 설정#
chmod 600 /etc/hosts

#/etc/syslog.conf 파일 소유자 및 권한 설정#
chmod 640 /etc/rsyslog.conf

#SUID, SGID 설정 파일점검#
chmod -s /sbin/unix_chkpwd
chmod -s /usr/bin/newgrp
chmod -s /usr/bin/at

#확인후 주석제거 SSR에서 검출된 내용.
#chmod -s /sbin/mount.nfs
#chmod -s /sbin/mount.nfs4
#chmod -s /sbin/umount.nfs
#chmod -s /sbin/umount.nfs4
#chmod -s /sbin/lockdev #device 잠금.
#chmod -s /sbin/grub2-set-bootflag #운영체제가 로드되는 기본 순서를 변경할 수있다.
#chmod -s /sbin/pam_timestamp_check #

#groupdel sys
#groupdel tty 
#groupdel disk 
#groupdel mem
#groupdel kmem
#groupdel cdrom
#groupdel man
#groupdel dialout
#groupdel floppy
#groupdel games
#groupdel tape
#groupdel video
#groupdel lock
#groupdel audio
#groupdel utmp
#groupdel utempter
#groupdel input
#groupdel render
#groupdel systemd-jouranl
#groupdel printadmin



#FTP 계정 쉘 제한
usermod -s/bin/false ftp 

#echo "umask 0022" >> /etc/.bashrc
echo  "umask 002" >> /home/${SU_USER}/.bash_profile
echo "export umask" >> /home/${SU_USER}/.bash_profile

echo  "umask 002" >> /home/${SERV_USER}/.bash_profile
echo "export umask" >> /home/${SERV_USER}/.bash_profile
#echo  "chmod 0022" >> /home/${MY_USER}/.bashrc
echo  "umask 002" >> /home/${TOM_USER}/.bash_profile
echo "export umask" >> /home/${TOM_USER}/.bash_profile

#관리자 계정 비밀번호 최대사용 기간 
chage -M 90 -W 7 ${SU_USER}
chage -M 90 -W 7 ${SERV_USER}
#chage -M 90 -W 7 root 

###########2022.09.29###########

#TCPwarraper 설정 
read -p "do you want apply ACL SSH service ? (y/n) :" STATUS
if [ ${STATUS} = y ] 
then
	firewall-cmd --permanent --remove-service=ssh
	read -p "input allow ACL SSH PORT : " PORT
	let COUNT
	read -p "IP Count :" COUNT
 	let IP_COUNT=0
  while [ $COUNT -gt $IP_COUNT ];
  do
	read -p "input allow ACL SSH IP (network:10.10.10.0/24 / host:10.10.10.1/32): " IP
 	firewall-cmd --permanent --add-rich-rule='rule family="ipv4" source address='${IP}' port port='${PORT}' protocol="tcp" accept'
  	echo '$IP_COUNT'
   	((IP_COUNT++))
  done
	firewall-cmd --reload
else
	echo "do not SSH ACL config..."
fi	


#패스워드 복잡도 설정

SY_AUTH=`ls -ahil /etc/pam.d/ | grep system-auth.bak`
PA_AUTH=`ls -ahil /etc/pam.d/ | grep password-auth.bak`

#계정임계치 설정.

authselect apply-changes -b --backup=sssd.backup

authselect create-profile user-profile -b sssd --symlink-meta --symlink-pam
authselect select custom/user-profile --force
authselect current
authselect enable-feature with-mkhomedir
authselect enable-feature with-faillock
authselect enable-feature with-pamaccess
authselect apply-changes 

echo "dir = /var/run/faillock
audit
deny=3
unlock_time=600
silent
event_deny_root
" >> /etc/security/faillock.conf 

echo "minlen = 9   
dcredit = -1
ucredit = -1
lcredit = -1
ocredit = -1
minclass = -1 
maxrepeat = 2
maxclassrepeat = 2 
difok = 5
enforce_for_root" >> /etc/security/pwquality.conf 
mkdir /etc/authselect/custom/user-profile/pam.d
ln -s /etc/pam.d/su /etc/authselect/custom/user-profile/pam.d/

authselect apply-changes

systemctl restart sshd

cp /etc/group group.bak
cp /etc/passwd passwd.bak
cp /etc/shadow shadow.bak 
#UMASK 값 
sed -i 's/002/022/g' /etc/bashrc
#sed -i "60s/.*/       umask 022/" /etc/bashrc

chmod 640 /var/log/dnf*
chmod 640 /var/log/btmp*
chmod 640 /var/log/hawkey*
chmod 640 /var/log/lastlog
chmod 640 /var/log/wtmp
chmod 640 /var/log/firewalld


#Cron서비스 사용 제한 
touch /etc/cron.allow 
echo "root" | tee -a /etc/cron.allow
chmod 600 /etc/cron.allow 


#SUID, SGID, STICK BIT 설정 확인.

SFIND=$(find / -xdev -user root -type f \( -perm -04000 -o -perm -02000 \) -exec ls -l {} \; | awk '{print $9}')
BAK_SFIND=$(find / -xdev -user root -type f \( -perm -04000 -o -perm -02000 \) -exec ls -l {} \;)

echo $BAK_SFIND > SU_G_ticky_bit.txt 
echo find / -type f -name ".*" > secrit_file.txt
echo find / -type d -name ".*" > secrit_dir.txt
:<<END
for S in ${SFIND[@]};
do
	echo $S
	STATE=""
	read -p "Change SUID, SGID, Sticky bit '${S}' All PASS 'q'" STATE

	case $STATE in
		y|Y) 
			chmod -x ${S}
		;;
		n|N)
			echo "Next..."
			continue
			;;
		q|Q)
			break
			;;
		*)
		echo "user defined input error" 
		;;
	esac
	
done
END 
