#!/bin/bash
########################################
#########  Tomcat 8.5.x 취약점 ##########
########################################
source 00.util_Install_latest


#Tomcat 취약점
#관리서버 디렉토리 권한 설정
chmod 750 ${DATA}/tomcat/work/Catalina/localhost/webapps
chmod 750 ${DATA}/tomcat/webapps

#설정 파일 권한 설정
chmod 600 ${DATA}/tomcat/conf/*.xml  
chmod 600 ${DATA}/tomcat/conf/*.properties 
chmod 600 ${DATA}/tomcat/conf/*.policy   

#로그 디렉토리/파일 권한 설정
chmod 750 ${DATA}/tomcat/logs

#불필요한 파일 및 디렉토리 삭제
rm -rf ${DATA}/tomcat/webapps

#패스워드 파일 권한 설정##
chmod 600 ${DATA}/tomcat/conf/tomcat-users.xml


#1.tomcat_spectify_file_handler_in_logging_properties_files

#2.tomcat_ensure_pattern_in_context_xml_is_correct

#3.tomcat_remove_the_default_application
rm -rf ${DATA}/tomcat/webapps

#4.tomcat_give_the_tomcat_user_account_an_invalid_shell
usermod -s /sbin/nologin tomcat #로그인 하지 않음.
usermod -d /data/tomcat tomcat #tomcat 홈디렉토리 변경
:<<END
#5.tomcat_lock_the_tomcat_user_account
cd ${DATA}/tomcat/lib; jar xf catalina.jar org/apache/catalina/util/ServerInfo.properties ; cd org/apache/catalina/util
SVR_INFO='server.info=MISOWEBSERVER'

cd ${DATA}/tomcat/lib; jar uf catalina.jar org/apache/catalina/util/ServerInfo.properties
#6.tomcat_server_platform_info

#7.tomcat_remove_server_banner

#8.tomcat_disable_client_facing_stack_tarces
RECYCLE='#=============<ADDED>===================
org.apache.catalina.connector.RECYCLE_FACADES=false' 
echo $RECYCLE >> ${DATA}/tomcat/conf/catalina.properties 

#9.tomcat_increase_the_entropy_in_session_identifiers

#10.tomcat_disable_the_shutdown_port

#11.tomcat_disable_deploy_on_startup_of_applications

#12.tomcat_starting_tomcat_with_security_manager
GRANT='grant codeBase "file:/${DATA}/miso/webapps/-" {
    permission java.security.AllPermission;
};' 
echo $GRANT >> ${DATA}/tomcat/conf/catalina.policy

#13.tomcat_enable_strict_servlet_compliance
echo "org.apache.catalina.STRICT_SERVLET_COMPLIANCE=true" >> ${DATA}/tomcat/conf/catalina.properties
END
