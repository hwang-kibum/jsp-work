#!/bin/bash

########################################
##########  Rocky 8.6 취약점 ###########
########################################


source 00.util_Install_latest

read  -p "client server? do not Server Vulnerability config (y/n) :" STAT

if [ ${STAT} == 'y' ];then
	exit;
fi 

#sed -i '5 i\auth\t   required\t/lib/security/pam_securetty.so' /etc/pam.d/login
sed -i 's/PermitRootLogin yes/PermitRootLogin no/' /etc/ssh/sshd_config
systemctl restart sshd

#패스워드 복잡성 설정#
#sed -i '15 i\password    requisite\t  pam_cracklib.so retry=3 minlen=8 lcredit=-1 ucredit=-1 dcredit=-1 ocredit=-1' /etc/pam.d/system-auth

#root 계정 su 제한#
#groupadd wheel




chgrp wheel /usr/bin/su
chmod 4750 /usr/bin/su
usermod -aG wheel ${SU_USER}
usermod -aG wheel root
 
#패스워드 최소 길이 설정#
sed -i '41,41 s/PASS_MIN_LEN.*/PASS_MIN_LEN\t8/g' /etc/login.defs

#패스워드 최대 사용기간 설정#
sed -i '39,39 s/PASS_MAX_DAYS.*/PASS_MAX_DAYS\t90/g' /etc/login.defs

#패스워드 최소 사용기간 설정#
sed -i '40,40 s/PASS_MIN_DAYS.*/PASS_MIN_DAYS\t1/g' /etc/login.defs

#패스워드 변경 경고 보내는 일수
#sed -i '28,28 s/PASS_WARN_AGE.*/PASS_WARN_AGE\t7/g' /etc/login.defs centos7은 7일로 되어있어서 안해도 됨

#Session Timeout 설정
echo -e "TMOUT=600\nexport TMOUT\n" >> /etc/profile
source /etc/profile

#정책에 따른 시스템 로깅 설정#
sed -i '67, 67 s/:omusrmsg:*//g' /etc/rsyslog.conf
sed -i '75 i\*.alert\t\t\t\t\t    /dev/console' /etc/rsyslog.conf 
systemctl restart rsyslog

#crond 파일 소유자 및 권한 설정#
chmod 750 /usr/bin/crontab
chmod 640 /etc/crontab
chmod 600 /etc/cron.deny 

#at 서비스 권한 설정#
chmod 750 /usr/bin/at
chmod 640 /etc/at.deny

#로그온 시 경고 메시지 제공#
#서버 로그인 메세지#
echo > /etc/motd.d/cockpit
sed -i '1 i\###########################################################################' /etc/motd.d/cockpit
sed -i '2 i\#                  This is a private computer facility.                   #' /etc/motd.d/cockpit
sed -i '3 i\#   Access for any reason must be specifically authrized by the manager.  #' /etc/motd.d/cockpit
sed -i '4 i\#Unless you are so authorized, your continued access and ant other use may#' /etc/motd.d/cockpit
sed -i '5 i\#             expose you to criminaland or civil proceedings              #' /etc/motd.d/cockpit
sed -i '6 i\###########################################################################' /etc/motd.d/cockpit


# ssh 로그인 메세지#
sed -i '129 i\Banner /etc/issue.net' /etc/ssh/sshd_config
echo > /etc/issue.net
sed -i '1 i\###########################################################################' /etc/issue.net
sed -i '2 i\#                                                                         #' /etc/issue.net
sed -i '3 i\#                             !!!WARNNING!!!                              #' /etc/issue.net
sed -i '4 i\#                                                                         #' /etc/issue.net
sed -i '5 i\###########################################################################' /etc/issue.net
sed -i '6 i\                !!! This System is for authrized user only !!!             ' /etc/issue.net

#/etc/hosts 파일 소유자 및 권한 설정#
chmod 600 /etc/hosts

#/etc/syslog.conf 파일 소유자 및 권한 설정#
chmod 640 /etc/rsyslog.conf

#SUID, SGID 설정 파일점검#
chmod -s /sbin/unix_chkpwd
chmod -s /usr/bin/newgrp
chmod -s /usr/bin/at


#FTP 계정 쉘 제한
chmod -x /bin/false ftp 

echo  "chmod 0022" >> /home/${SU_USER}/.bashrc
echo  "chmod 0022" >> /home/${SERV_USER}/.bashrc
#echo  "chmod 0022" >> /home/${MY_USER}/.bashrc
echo  "chmod 0022" >> /home/${TOM_USER}/.bashrc

###########2022.09.29###########

#TCPwarraper 설정 
read -p "do you want apply ACL SSH service ? (y/n) :" STATUS
if [ ${STATUS} = y ] 
then
	firewall-cmd --permanent --remove-service=ssh
	read -p "input allow ACL SSH PORT : " PORT
	read -p "IP Count :" COUNT
  for [ i=0; i < COUNT; i++ ];
  do
	read -p "input allow ACL SSH IP (network:10.10.10.0/24 / host:10.10.10.1/32): " IP
 	firewall-cmd --permanent --add-rich-rule='rule family="ipv4" source address='${IP}' port port='${PORT}' protocol="tcp" accept'
  done
	firewall-cmd --reload
else
	echo "do not SSH ACL config..."
fi	


#패스워드 복잡도 설정

SY_AUTH=`ls -ahil /etc/pam.d/ | grep system-auth.bak`
PA_AUTH=`ls -ahil /etc/pam.d/ | grep password-auth.bak`

#계정임계치 설정.

authselect apply-changes -b --backup=sssd.backup

authselect create-profile user-profile -b sssd --symlink-meta --symlink-pam
authselect select custom/user-profile
authselect current
authselect enable-feature with-mkhomedir
authselect enable-feature with-faillock
authselect apply-changes 

echo "dir = /var/run/faillock
deny=5
unlock_time=1200
silent" >> /etc/security/faillock.conf 

echo "minlen = 9   
dcredit = -1
ucredit = -1
lcredit = 1
ocredit = 1
minclassi = 1 
maxrepeat = 2
maxclassrepeat = 2 
difok = 5 " >> /etc/security/pwquality.conf 

authselect apply-changes

systemctl restart sshd


#UMASK 값 
sed -i "75s/.*/       umask 022/" /etc/bashrc
#sed -i "60s/.*/       umask 022/" /etc/bashrc

#


#SUID, SGID, STICK BIT 설정 확인.

SFIND=$(find / -xdev -user root -type f \( -perm -04000 -o -perm -02000 \) -exec ls -l {} \; | awk '{print $9}')
BAK_SFIND=$(find / -xdev -user root -type f \( -perm -04000 -o -perm -02000 \) -exec ls -l {} \;)

echo $BAK_SFIND > SU_G_ticky_bit.txt 

:<<END
for S in ${SFIND[@]};
do
	echo $S
	STATE=""
	read -p "Change SUID, SGID, Sticky bit '${S}' All PASS 'q'" STATE

	case $STATE in
		y|Y) 
			chmod -x ${S}
		;;
		n|N)
			echo "Next..."
			continue
			;;
		q|Q)
			break
			;;
		*)
		echo "user defined input error" 
		;;
	esac
	
done
END 
